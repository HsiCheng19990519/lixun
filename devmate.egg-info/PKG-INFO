Metadata-Version: 2.4
Name: devmate
Version: 0.1.0
Summary: DevMate: coding assistant agent with MCP, RAG and web search
Requires-Python: >=3.13
Description-Content-Type: text/markdown
Requires-Dist: langchain>=1.1.0
Requires-Dist: langchain-openai>=0.2.0
Requires-Dist: langchain-community>=0.3.0
Requires-Dist: langchain-chroma>=0.1.0
Requires-Dist: langchain-deepseek>=0.1.0
Requires-Dist: langchain-text-splitters>=0.3.0
Requires-Dist: chromadb>=0.5.0
Requires-Dist: pydantic-settings>=2.5.0
Requires-Dist: tavily-python>=0.3.0
Requires-Dist: langsmith>=0.1.0
Requires-Dist: fastapi>=0.115.0
Requires-Dist: uvicorn>=0.30.0
Requires-Dist: huggingface-hub>=0.24.0
Requires-Dist: langchain-huggingface>=0.1.0
Requires-Dist: sentence-transformers>=2.2.2
Requires-Dist: modelcontextprotocol>=0.1.0

# DevMate（Stage 1-3）

本分支覆盖 Stage 1（环境/依赖/配置基线）、Stage 2（MCP 搜索工具）与 Stage 3（本地 RAG）。后续 Agent/Docker/观测性未实现。

## 已完成
- Stage 1：`uv` 管理 Python 3.13；`pyproject.toml` 声明 LangChain 1.x 等依赖；`devmate/config.py::Settings` 统一读取（env > .env > config.toml），敏感文件忽略已处理。
- Stage 2：MCP 搜索（FastMCP，集成 Tavily）  
  - 服务器：`mcp_server/main.py` 暴露 `search_web`，支持 `stdio` / `sse` / `streamable-http`（默认 stdio，可用 `MCP_TRANSPORT` 切换），需 `TAVILY_API_KEY`。  
  - 客户端：`devmate/mcp_client/client.py`、`scripts/test_mcp_client.py` 默认 stdio，可切换 SSE/HTTP。  
  - Tavily 实现：`mcp_server/tools.py::SearchService` / `mcp_server/main.py::call_tavily`。
- Stage 3：RAG  
  - 文档：`docs/internal_guidelines.md`、`docs/templates.md`、`docs/internal_fastapi_guidelines.md`。  
  - 向量库：`devmate/rag/ingest.py`（langchain-chroma + BAAI/bge-m3，持久化 `data/vector_store`，遥测关闭）。  
  - 检索：`devmate/rag/retriever.py::search_knowledge_base`，脚本 `scripts/test_rag.py` 可验证。

## 快速开始
1) 安装依赖  
```
uv sync
```

2) 配置变量  
- Tavily：`TAVILY_API_KEY`  
- LLM/Embedding：`MODEL_NAME`、`EMBEDDING_MODEL_NAME`，闭源时 `AI_BASE_URL`、`API_KEY`  
- RAG：`VECTOR_STORE_DIR`、`CHUNK_SIZE`、`CHUNK_OVERLAP`（可选）

3) 环境快速验证（仅实例化，不发请求）  
```
uv run python scripts/check_env.py
```

4) 启动 MCP 服务器（默认 stdio，可切换 transport）  
```
set TAVILY_API_KEY=your_key
# 默认 stdio：MCP_TRANSPORT=stdio
uv run python -m mcp_server.main
# 如需 HTTP：set MCP_TRANSPORT=streamable-http
# 如需 SSE：set MCP_TRANSPORT=sse
```

5) 测试 MCP 客户端（默认 stdio）  
```
uv run python scripts/test_mcp_client.py --query "model context protocol"
```
- HTTP：`--transport http --http-url http://127.0.0.1:8010/mcp`  
- SSE：`--transport sse`（需 server 以 sse 启动）  
预期：输出 Tavily 结果（或缺 key 的错误），`logs/mcp_server_stderr.log` 可见 `search_web query=...`。

6) 文档摄入（Stage 3）  
```
uv run python scripts/ingest_docs.py --rebuild
```
说明：读取 `docs/`，切分并写入 `data/vector_store`（遥测关闭）。

7) 知识库查询（Stage 3 验证）  
```
uv run python scripts/test_rag.py --query "project guidelines"
```
预期命中本地文档片段（文件名视 docs/ 内容而定）。

## 文件速览
- `pyproject.toml`：LangChain 1.x、langchain-chroma、langchain-deepseek、langchain-huggingface、sentence-transformers 等依赖；脚本入口。
- `.env` / `config.toml`：LLM/Embedding/Tavily 配置示例。
- `devmate/config.py`：配置加载逻辑（env 优先，忽略未知字段，支持大写别名）。
- `devmate/llm.py`：ChatOpenAI/ChatDeepSeek、OpenAI/HuggingFace Embeddings 工厂。
- `devmate/logging_utils.py`：stderr + 滚动日志。
- `mcp_server/main.py`、`mcp_server/tools.py`：MCP server + Tavily 搜索。
- `devmate/mcp_client/client.py`、`scripts/test_mcp_client.py`：MCP 客户端与测试脚本。
- `devmate/rag/ingest.py`、`devmate/rag/retriever.py`、`scripts/ingest_docs.py`、`scripts/test_rag.py`：RAG 摄入与检索。
- `docs/*`：本地知识库示例文档。

## 限制
- 仅涵盖 Stage 1-3；Agent/Docker/观测链路未提供。  
- Windows 环境下 stdio 可用；SSE/HTTP 需对应 transport/端口。  
- 必须设置 `TAVILY_API_KEY` 才能获得真实搜索结果。  

## 修改记录（MCP 客户端超时修复）
- 曾遇 stdio 模式 `ClientSession` 初始化超时，已通过在客户端侧使用 `async with ClientSession(...)` 包裹会话修复。  
- 参考讨论：https://stackoverflow.com/questions/79692462/fastmcp-client-timing-out-while-initializing-the-session  
