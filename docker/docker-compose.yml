version: "3.9"

services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: devmate:latest
    env_file:
      - ../.env
    environment:
      CHROMA_HOST: vector-db
      CHROMA_HTTP_PORT: 8000
      MCP_TRANSPORT: stdio
      HF_ENDPOINT: https://hf-mirror.com
      HUGGINGFACE_HUB_BASE_URL: https://hf-mirror.com
      HF_HOME: /app/data/hf_cache
      HUGGINGFACE_HUB_CACHE: /app/data/hf_cache/hub
    command: >
      /app/.venv/bin/python -m devmate.cli
      --stage5 --transport stdio
      --k 4 --max-iterations 6 --output-dir /app/data/stage5_output
    depends_on:
      vector-db:
        condition: service_started
    volumes:
      - ../data:/app/data
      - ../logs:/app/logs
      - ../docs:/app/docs

  ingest:
    image: devmate:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
    env_file:
      - ../.env
    environment:
      CHROMA_HOST: vector-db
      CHROMA_HTTP_PORT: 8000
      HF_ENDPOINT: https://hf-mirror.com
      HUGGINGFACE_HUB_BASE_URL: https://hf-mirror.com
      HF_HOME: /app/data/hf_cache
      HUGGINGFACE_HUB_CACHE: /app/data/hf_cache/hub
    command: /app/.venv/bin/python -m scripts.ingest_docs --rebuild
    depends_on:
      vector-db:
        condition: service_started
    volumes:
      - ../docs:/app/docs
      - ../logs:/app/logs
      - ../data:/app/data

  vector-db:
    image: ghcr.io/chroma-core/chroma:1.3.6
    environment:
      CHROMA_SERVER_CORS_ALLOW_ORIGINS: "*"
      ALLOW_RESET: "TRUE"
    ports:
      - "8000:8000"
    volumes:
      - vector_store_data:/chroma/data

volumes:
  vector_store_data:
    driver: local
